<!DOCTYPE html>
<html>
    {{template "header.tmpl.html"}}
    <body onload="reset();">
        <h1 class="center">Multi Account</h1>
        <div class="container">
            <div class="center">
                <input id="search" placeholder="Search ID here..." oninput="initSearch();" style="position: absoulte;"/>
            </div>
            <div id ="card-container" class="row">
            </div>
            <div class="center">
                <div id="not-found" class="card warning double-padded" style="margin: 0 auto; visibility: hidden;">Multi Acc not found</div>
            </div>
            <div class="center">
                <div class="spinner primary"></div>
            </div>
        </div>
        <script>
            var offset = 0;
            var urlLocks = [];
            
            window.onscroll = function(ev) {
                if ((window.innerHeight + window.pageYOffset) >= document.body.offsetHeight) {
                    search();
                }
            };

            function initSearch() {
                offset = 0;
                document.getElementById('card-container').innerHTML = '';
                urlLocks.length = 0;  // reset locks
                search();
            }

            function search() {
                var query = document.getElementById('search').value;
                var url = '/api/multi_acc?offset='+offset+'&query='+query;
                if (urlLocks.includes(url)) {
                    return
                }
                urlLocks.push(url);
                spinner(true);
                fetch(url, {
                    credentials: 'same-origin'
                })
                .then(res => res.json())
                .then(json => {
                    var currentQuery = document.getElementById('search').value;
                    if (currentQuery !== json.data.query) {
                        return
                    }
                    spinner(false);
                    if (json.status === 'OK') {
                        if (offset == 0 && json.data.accounts == null) {
                            notFound(true);
                        } else {
                            notFound(false);
                            appendCards(json.data.accounts);
                            offset += json.data.accounts.length;
                            window._data = json.data;
                        }
                        urlLocks.length = 0;
                    } else if (json.status === 'error'){
                        notFound(true);
                    }
                })
            }

            function reset() {
                offset = 0;
                document.getElementById('search').value = '';
                initSearch();
            }

            function notFound(v) {
                var n = document.getElementById('not-found');
                if (v) {
                    n.style.visibility = 'visible';
                } else {
                    n.style.visibility = 'hidden';
                }
            }

            function spinner(b) {
                var n = document.querySelector('.spinner');
                n.style.visibility = b ? 'visible' : 'hidden';
            }

            function appendCards(cards) {
                var cc = document.getElementById('card-container');
                cards.forEach(card => {
                    var c = document.createElement('div');
                    c.setAttribute('class', 'card fluid');
                    c.setAttribute('id', card.id);

                    var s1 = document.createElement('div');
                    s1.setAttribute('class', 'section');

                    var a = document.createElement('a');
                    a.setAttribute('href', 'https://www.instagram.com/'+card.id);
                    a.setAttribute('target', '_blank')
                    var active = card.active ? 'active' : 'inactive';
                    a.innerHTML = '@' + card.id + '('+active+')';
                    s1.appendChild(a);

                    var s2 = document.createElement('div');
                    s2.setAttribute('class', 'section');

                    var btnActivate = document.createElement('button');
                    btnActivate.setAttribute('id', 'active-'+card.id);
                    btnActivate.setAttribute('data-id', card.id);
                    btnActivate.setAttribute('onclick', 'activate(this);');
                    btnActivate.innerHTML = 'Activate';
                    s2.appendChild(btnActivate);

                    var btnDelete = document.createElement('button');
                    btnDelete.setAttribute('id', 'delete-'+card.id);
                    btnDelete.setAttribute('data-id', card.id);
                    btnDelete.setAttribute('onclick', 'deleteMultiAcc(this)');
                    btnDelete.innerHTML = 'Delete';
                    s2.appendChild(btnDelete);

                    if (card.active) {
                        btnActivate.setAttribute('disabled', 'disabled');
                        btnActivate.setAttribute('class', 'button');

                        btnDelete.setAttribute('class', 'secondary');
                        btnDelete.removeAttribute('disabled');
                    } else {
                        btnActivate.removeAttribute('disabled');
                        btnActivate.setAttribute('class', 'primary');

                        btnDelete.setAttribute('disabled', 'disabled');
                        btnDelete.setAttribute('class', 'button');
                    }
                    
                    c.appendChild(s1);
                    c.appendChild(s2);
                    cc.appendChild(c);
                });
            }

            function toggleActive(nid, act) {
                var dn = document.getElementById('active-'+nid);
                var delb = document.getElementById('delete-'+nid);
                if (act) {
                    dn.removeAttribute('disabled');
                    dn.setAttribute('class', 'primary');

                    delb.setAttribute('disabled', 'disabled');
                    delb.setAttribute('class', 'button');
                } else {
                    dn.setAttribute('disabled', 'disabled');
                    dn.setAttribute('class', 'button');

                    delb.removeAttribute('disabled');
                    delb.setAttribute('class', 'secondary');
                }
            }

            function deleteMultiAcc(btn) {
                var nid = btn.getAttribute('data-id');
                fetch('/api/multi_acc/'+nid, {
                    method: 'DELETE',
                    credentials: 'same-origin',
                })
                .then(res => res.json())
                .then(json => {
                    if (json.status === 'OK') {
                        toggleActive(nid, true);
                    }
                })
                .catch(err => console.error(err))
            }

            function activate(btn) {
                var nid = btn.getAttribute('data-id');
                fetch('/api/multi_acc/'+nid, {
                    method: 'POST',
                    credentials: 'same-origin',
                })
                .then(res => res.json())
                .then(json => {
                    if (json.status === 'OK') {
                        toggleActive(nid, false);
                    }
                })
                .catch(err => console.error(err))
            }
            
        </script>
    </body>
</html>